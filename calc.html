<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gorski Finance Calculator</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="./img/gorsko-logo.png" type="image/x-icon" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script>
      window.addEventListener("scroll", function () {
        document.body.classList.toggle("scrolled", window.scrollY > 50);
      });
    </script>
  </head>
  <body>
    <header>
      <div class="logo">
        <img src="./img/gorsko-logo.png" alt="Logo" class="logo-img" />
        <span>Gorski<br /><small>Finance Calculator</small></span>
      </div>
      <nav class="menu">
        <a href="index.html"><img src="./img/home.png" alt="Home" /></a>
        <a href="calc.html"><img src="./img/calc.png" alt="Calc"></a>
        <a href="achv.html"><img src="./img/trophy.png" alt="Videos" /></a>
        <a href="contact.html"
          ><img src="./img/contacts.png" alt="Contacts"
        /></a>
        <a href="login.html"><img src="./img/login.png" alt="Login" /></a>
      </nav>
    </header>

    <div class="banner">
      <img src="./img/fa.png" alt="Forest Background" />
    </div>
    <main>
      <div class="content">
        <div class="row">
          <div class="left-column">
            <h1>Калкулатор за финанси</h1>
            <p>Въведете сума и причини</p>
            <hr />
            <br />
            <form id="finance-form" action="/calc" method="post">
                <h3>Доходи</h3>
                <br>
              <div id="income-entries">
                <div class="income-entry">
                  <label for="sum">Сума:</label>
                  <input type="number" id="sum" name="sum[]" required />
                  <br />
                  <label for="income-reason">Причина за доход:</label>
                  <select id="income-reason" name="income-reason[]" required onchange="toggleCustomReason(this)">
                    <option value="job">Работа</option>
                    <option value="other">Друго</option>
                  </select>
                  <br />
                  <input type="text" name="custom-income-reason[]" class="custom-reason" placeholder="Въведете причина" style="display:none;" />
                </div>
              </div>
              <br>
              <button type="button" onclick="addIncomeEntry()">Добави още доход</button>
              <br>
              <hr>
              <h3>Разходи</h3>
              <br>
              <div id="outcome-entries">
                <div class="outcome-entry">
                  <label for="sum">Сума:</label>
                  <input type="number" id="sum" name="sum[]" required />
                  <br />
                  <label for="outcome-reason">Причина за разход:</label>
                  <select id="outcome-reason" name="outcome-reason[]" required onchange="toggleCustomReason(this)">
                    <option value="bills">Сметки</option>
                    <option value="entertainment">Развлечения</option>
                    <option value="other">Друго</option>
                  </select>
                  <br />
                  <input type="text" name="custom-outcome-reason[]" class="custom-reason" placeholder="Въведете причина" style="display:none;" />
                </div>
              </div>
              <br>
              <button type="button" onclick="addOutcomeEntry()">Добави още разход</button>
              <br />
              <button type="submit">Изчисли</button>
            </form>
          </div>
          <div class="right-column">Image here</div>
        </div>
      </div>
    </main>
    <footer>
      <div class="footer-content">
        За повече информация изпратете e-mail на
        <a href="https://mail.google.com/mail/u/0/#inbox?compose=new"
          >gorskite4@gmail.com</a
        >
      </div>
      <nav class="footer-menu">
        <a href="index.html">Home</a>
        <a href="calc.html">Calculator</a>
        <a href="achv.html">Achievements</a>
        <a href="contact.html">Contacts</a>
      </nav>
    </footer>
    <script src="financeTracker.js"></script>
    document.addEventListener("DOMContentLoaded", function () {
      const financeForm = document.getElementById("finance-form");
  
      financeForm.addEventListener("submit", async function (event) {
          event.preventDefault(); // Prevent form submission
          
          // Collect Income Data
          let incomeEntries = [];
          document.querySelectorAll("#income-entries .income-entry").forEach(entry => {
              let amount = entry.querySelector("input[name='sum[]']").value;
              let reasonSelect = entry.querySelector("select[name='income-reason[]']");
              let reason = reasonSelect.value === "other" 
                  ? entry.querySelector("input[name='custom-income-reason[]']").value 
                  : reasonSelect.value;
  
              if (amount && reason) {
                  incomeEntries.push({ source: reason, amount: parseFloat(amount) });
              }
          });
  
          // Collect Outcome Data
          let outcomeEntries = [];
          document.querySelectorAll("#outcome-entries .outcome-entry").forEach(entry => {
              let amount = entry.querySelector("input[name='sum[]']").value;
              let reasonSelect = entry.querySelector("select[name='outcome-reason[]']");
              let reason = reasonSelect.value === "other" 
                  ? entry.querySelector("input[name='custom-outcome-reason[]']").value 
                  : reasonSelect.value;
  
              if (amount && reason) {
                  outcomeEntries.push({ source: reason, amount: parseFloat(amount) });
              }
          });
  
          // Send income data to backend
          await fetch("http://localhost:4000/finance/add-income", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ entries: incomeEntries })
          });
  
          // Send outcome data to backend
          await fetch("http://localhost:4000/finance/add-outcome", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ entries: outcomeEntries })
          });
  
          // Fetch and display savings calculation
          const response = await fetch("http://localhost:4000/finance/calculate-savings");
          const data = await response.json();
  
          alert(`Спестявания: ${data.savings} лв\nРазходи: ${data.spending} лв`);
      });
  });
  
  // Function to add more income entries
  function addIncomeEntry() {
      let incomeDiv = document.createElement("div");
      incomeDiv.classList.add("income-entry");
      incomeDiv.innerHTML = `
          <label for="sum">Сума:</label>
          <input type="number" name="sum[]" required />
          <br />
          <label for="income-reason">Причина за доход:</label>
          <select name="income-reason[]" required onchange="toggleCustomReason(this)">
              <option value="job">Работа</option>
              <option value="other">Друго</option>
          </select>
          <br />
          <input type="text" name="custom-income-reason[]" class="custom-reason" placeholder="Въведете причина" style="display:none;" />
      `;
      document.getElementById("income-entries").appendChild(incomeDiv);
  }
  
  // Function to add more outcome entries
  function addOutcomeEntry() {
      let outcomeDiv = document.createElement("div");
      outcomeDiv.classList.add("outcome-entry");
      outcomeDiv.innerHTML = `
          <label for="sum">Сума:</label>
          <input type="number" name="sum[]" required />
          <br />
          <label for="outcome-reason">Причина за разход:</label>
          <select name="outcome-reason[]" required onchange="toggleCustomReason(this)">
              <option value="bills">Сметки</option>
              <option value="entertainment">Развлечения</option>
              <option value="other">Друго</option>
          </select>
          <br />
          <input type="text" name="custom-outcome-reason[]" class="custom-reason" placeholder="Въведете причина" style="display:none;" />
      `;
      document.getElementById("outcome-entries").appendChild(outcomeDiv);
  }
  
  // Show custom reason input when "Other" is selected
  function toggleCustomReason(selectElement) {
      let customInput = selectElement.parentElement.querySelector(".custom-reason");
      customInput.style.display = selectElement.value === "other" ? "block" : "none";
  }
  script src="script.js"></script>
  </body>
</html>
